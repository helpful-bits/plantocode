# Vibe Manager Server

This is the backend server for Vibe Manager, built with Rust and Actix Web.

## Features

- REST API endpoints with Actix Web
- PostgreSQL database integration with SQLx
- Firebase-based OAuth authentication (Google, GitHub, Apple, Microsoft)
- JWT token issuance and validation
- Token binding for enhanced security
- Environment-based configuration
- Comprehensive error handling
- Database connection pooling

## Setup

### Prerequisites

- Rust (latest stable version)
- PostgreSQL
- Firebase project with authentication enabled
- SQLx CLI (for database migrations)

### Installation

1. Clone the repository
2. Navigate to the server directory
3. Copy the example environment file and update it:

```bash
cp .env.example .env
# Edit .env with your configuration
```

4. Create a database in PostgreSQL:

```bash
createdb vibe_manager
```

5. Run database migrations:

You can use the SQLx CLI or the consolidated migration script:

**Using SQLx CLI:**
```bash
sqlx migrate run
```

**Using consolidated migration script:**
```bash
npm install
npm run apply-migration
# Or directly:
npx tsx scripts/apply-consolidated-migration.ts
```

The consolidated migration script applies all database schema changes at once, which is useful for initial setup or resetting the database to a known state.

6. Build and run the server:

```bash
cargo run
```

### Environment Variables

- `APP_NAME`: Application name (default: "vibe-manager")
- `ENVIRONMENT`: Environment (e.g., "development", "production")
- `SERVER_HOST`: Host to bind the server to (default: "0.0.0.0")
- `SERVER_PORT`: Port to listen on (default: 8080)
- `CORS_ORIGINS`: Comma-separated list of allowed origins for CORS (default: "*")
- `DATABASE_URL`: PostgreSQL connection string
- `JWT_SECRET`: Secret key for JWT signing (must be at least 32 characters)
- `JWT_ACCESS_TOKEN_DURATION_DAYS`: Duration of access tokens in days (default: 30)
- `FIREBASE_API_KEY`: Your Firebase project API key
- `FIREBASE_PROJECT_ID`: Your Firebase project ID
- `REPLICATE_API_TOKEN`: (Optional) Legacy Replicate API token - not used with direct OpenAI transcription

## Authentication Flow

Vibe Manager uses Firebase Authentication for OAuth sign-in:

1. The client authenticates with Firebase using one of the supported providers (Google, GitHub, Apple, Microsoft)
2. The client sends the Firebase ID token to the server endpoint `/auth/firebase/token`
3. The server verifies the token with Firebase, extracts the user information, and issues a JWT token
4. The client includes this JWT token in the Authorization header for subsequent API requests
5. Protected endpoints validate the JWT token and extract user information

## API Endpoints

### Public Endpoints

- `GET /health`: Health check endpoint
- `POST /auth/firebase/token`: Exchange a Firebase ID token for a JWT token

### Protected Endpoints (requires authentication)

- Protected API endpoints are available under `/api`
- Authentication is required via Bearer token in the Authorization header

## Development

To run the server in development mode with hot reloading:

```bash
cargo watch -x run
```

## Testing

To run the tests:

```bash
cargo test
```

## Billing Flows

### Payment Method Usage

- **Credit purchases**: Use on-session Stripe Checkout with the customer's default payment method preselected (but changeable by the user). The checkout session now displays itemized charges:
  - "Top-up Credits" - The net amount credited to the user's account
  - "Processing fee" - The platform fee charged for the transaction
  
- **Auto top-off**: Uses off-session charging via invoice/PaymentIntent against the customer's default payment method automatically without user interaction.

Both flows ensure that invoices generated by Stripe display transparent, itemized charges for better visibility into fees and net amounts.

### Customer Billing Emails

- The system relies on Stripe to send customer receipts and invoice emails.
- Ensure in the Stripe Dashboard that account-level email settings are enabled for:
  - "Email customers for successful payments"
  - Invoice email notifications
- Confirm each Stripe Customer has a valid email set; otherwise Stripe cannot deliver receipts/invoices.
- Mailgun (if configured) is used only for admin/operational alerts. Customer purchase receipts/invoices are not sent via Mailgun.

## Docker

This application can be built and run using Docker. The provided `Dockerfile` uses a multi-stage build to create a minimal, secure, and optimized image.

### Building the Image

Navigate to the `server` directory and run the following command to build the image:

```bash
docker build -t vibe-manager-server .
```

### Running the Container

To run the container, you must provide the necessary environment variables, such as `DATABASE_URL` and `REDIS_URL`. The easiest way is to use an `.env` file.

```bash
docker run --rm -it \
  -p 8080:8080 \
  --env-file ./.env \
  --name vibe-manager-server \
  vibe-manager-server
```

**Notes:**
- The `--env-file ./.env` flag assumes you have a `.env` file in the `server/` directory based on the `.env.example` file.
- The container exposes port `8080`, which is mapped to port `8080` on the host.
- The application will attempt to connect to the database and Redis instances specified in your environment variables. Ensure the container can reach them (e.g., by using `host.docker.internal` on Docker Desktop or appropriate container networking).