name: Build Desktop Apps with Updater Artifacts

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
    paths:
      - 'desktop/**'
      - 'server/**'
      - '.github/workflows/windows-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'desktop/**'
      - 'server/**'
      - '.github/workflows/windows-build.yml'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  build-windows:
    name: Build Windows with Updater Artifacts
    runs-on: windows-latest  # GitHub default runner
    # FAST ALTERNATIVES (Windows runners that actually work):
    # runs-on: depot-windows-32vcpu-x64          # Depot: 32 vCPU, 4x cheaper - sign up at depot.dev
    # runs-on: runson-windows-x64-4cpu           # RunsOn: Self-hosted in your AWS - runs-on.com
    # 
    # DON'T WORK FOR WINDOWS:
    # BuildJet: Linux/Ubuntu only, no Windows support
    # WarpBuild: Windows support "coming soon" (not available yet)
    # Namespace: No Windows support
    # Blacksmith: No Windows support
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        run_install: false
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
      
    - name: Install Rust toolchain
      run: rustup toolchain install stable --profile minimal --target x86_64-pc-windows-msvc
        
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "desktop/src-tauri -> target"
        cache-targets: "true"
        cache-on-failure: "false"
        prefix-key: "v1-rust-windows"
          
    - name: Install dependencies
      run: |
        cd desktop
        pnpm install
      
    - name: Build frontend
      run: |
        cd desktop
        pnpm run build
      
    - name: Cache Tauri CLI
      id: cache-tauri
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-tauri
        key: ${{ runner.os }}-tauri-cli-2.0
        
    - name: Install Tauri CLI
      if: steps.cache-tauri.outputs.cache-hit != 'true'
      run: cargo install tauri-cli --version "^2.0" --locked
      
    - name: Get App Version
      run: |
        $version = (Get-Content desktop/package.json | ConvertFrom-Json).version
        echo "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh
      
    - name: Build Windows app with updater artifacts
      run: |
        cd desktop
        cargo tauri build --target x86_64-pc-windows-msvc
      env:
        TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-updater-artifacts-${{ github.sha }}
        path: |
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi.zip
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi.zip.sig
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.nsis.zip
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.nsis.zip.sig
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload Windows signature for latest.json
      uses: actions/upload-artifact@v4
      with:
        name: signature-windows-x86_64
        path: desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi.zip.sig
        retention-days: 1
        if-no-files-found: warn
    
    - name: Publish to S3 (if on main branch with secrets)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push' && env.AWS_ACCESS_KEY_ID != ''
      run: |
        # Install AWS CLI if not present
        if ! command -v aws &> /dev/null; then
          curl "https://awscli.amazonaws.com/AWSCLIV2.msi" -o "AWSCLIV2.msi"
          msiexec.exe /i AWSCLIV2.msi /quiet
          $env:Path += ";C:\Program Files\Amazon\AWSCLIV2"
        fi
        
        # Rename artifacts with underscores and upload
        cd desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi
        $version = "${{ env.APP_VERSION }}"
        
        # Find and rename MSI zip with underscores
        Get-ChildItem -Filter "*.msi.zip" | ForEach-Object {
          $newName = "Vibe_Manager_${version}_x64_en-US.msi.zip"
          Move-Item $_.Name $newName -Force
          Move-Item "$($_.Name).sig" "${newName}.sig" -Force
        }
        
        aws s3 cp . s3://vibemanager.app/ --recursive --exclude "*" --include "Vibe_Manager_*.msi.zip" --include "Vibe_Manager_*.msi.zip.sig"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-central-1

  build-macos:
    name: Build macOS ${{ matrix.target }} with Updater Artifacts
    runs-on: macos-latest  # GitHub default runner (sufficient for macOS)
    timeout-minutes: 30
    strategy:
      matrix:
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        run_install: false
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
      
    - name: Install Rust toolchain
      run: rustup toolchain install stable --profile minimal --target ${{ matrix.target }}
    
    - name: Install OpenSSL for cross-compilation
      run: |
        brew install openssl@3
        echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig" >> $GITHUB_ENV
        
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "desktop/src-tauri -> target"
        cache-targets: "true"
        cache-on-failure: "false"
        prefix-key: "v1-rust-macos"
          
    - name: Install dependencies
      run: |
        cd desktop
        pnpm install
      
    - name: Build frontend
      run: |
        cd desktop
        pnpm run build
      
    - name: Cache Tauri CLI
      id: cache-tauri
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-tauri
        key: ${{ runner.os }}-tauri-cli-2.0
        
    - name: Install Tauri CLI
      if: steps.cache-tauri.outputs.cache-hit != 'true'
      run: cargo install tauri-cli --version "^2.0" --locked
      
    - name: Get App Version
      run: echo "APP_VERSION=$(jq -r .version desktop/package.json)" >> $GITHUB_ENV
      shell: bash
      
    - name: Build macOS app with updater artifacts
      run: |
        cd desktop
        cargo tauri build --target ${{ matrix.target }}
      env:
        TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        OPENSSL_DIR: ${{ env.OPENSSL_DIR }}
        PKG_CONFIG_PATH: ${{ env.PKG_CONFIG_PATH }}
        
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-updater-artifacts-${{ matrix.target }}-${{ github.sha }}
        path: |
          desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
          desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
          desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz.sig
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload macOS signature for latest.json
      uses: actions/upload-artifact@v4
      with:
        name: signature-macos-${{ matrix.target }}
        path: desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz.sig
        retention-days: 1
        if-no-files-found: warn
    
    - name: Publish to S3 (if on main branch with secrets)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push' && env.AWS_ACCESS_KEY_ID != ''
      run: |
        # Rename artifacts with underscores and upload
        cd desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos
        VERSION="${{ env.APP_VERSION }}"
        TARGET="${{ matrix.target }}"
        
        # Rename with underscores
        for file in *.app.tar.gz; do
          if [ -f "$file" ]; then
            NEW_NAME="Vibe_Manager_${VERSION}_${TARGET}.app.tar.gz"
            mv "$file" "$NEW_NAME"
            mv "${file}.sig" "${NEW_NAME}.sig"
          fi
        done
        
        aws s3 cp . s3://vibemanager.app/ --recursive --exclude "*" --include "Vibe_Manager_*.app.tar.gz" --include "Vibe_Manager_*.app.tar.gz.sig"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-central-1
  
  publish-latest-json:
    name: Generate and Publish latest.json to S3
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all signature artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: signature-*
        path: artifacts/
    
    - name: Get App Version
      run: echo "APP_VERSION=$(jq -r .version desktop/package.json)" >> $GITHUB_ENV
    
    - name: Generate and upload latest.json
      if: env.AWS_ACCESS_KEY_ID != ''
      run: |
        set -euo pipefail
        
        APP_VERSION="${{ env.APP_VERSION }}"
        CDN_BASE="https://d2tyb0wucqqf48.cloudfront.net"
        PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # Read signatures (handle if files don't exist)
        SIG_WIN=""
        SIG_MAC_ARM=""
        SIG_MAC_INTEL=""
        
        if [ -f "artifacts/signature-windows-x86_64/*.sig" ]; then
          SIG_WIN=$(cat artifacts/signature-windows-x86_64/*.sig 2>/dev/null || true)
        fi
        
        if [ -f "artifacts/signature-macos-aarch64-apple-darwin/*.sig" ]; then
          SIG_MAC_ARM=$(cat artifacts/signature-macos-aarch64-apple-darwin/*.sig 2>/dev/null || true)
        fi
        
        if [ -f "artifacts/signature-macos-x86_64-apple-darwin/*.sig" ]; then
          SIG_MAC_INTEL=$(cat artifacts/signature-macos-x86_64-apple-darwin/*.sig 2>/dev/null || true)
        fi
        
        # Build JSON dynamically
        cat > latest.json << 'EOF'
        {
          "version": "$APP_VERSION",
          "notes": "Bug fixes and performance improvements",
          "pub_date": "$PUB_DATE",
          "platforms": {}
        }
        EOF
        
        # Add Windows platform if signature exists
        if [ -n "$SIG_WIN" ]; then
          WIN_URL="${CDN_BASE}/Vibe_Manager_${APP_VERSION}_x64_en-US.msi.zip"
          jq --arg url "$WIN_URL" --arg sig "$SIG_WIN" \
            '.platforms["windows-x86_64"] = {"url": $url, "signature": $sig}' \
            latest.json > tmp.json && mv tmp.json latest.json
        fi
        
        # Add macOS ARM platform if signature exists
        if [ -n "$SIG_MAC_ARM" ]; then
          MAC_ARM_URL="${CDN_BASE}/Vibe_Manager_${APP_VERSION}_aarch64-apple-darwin.app.tar.gz"
          jq --arg url "$MAC_ARM_URL" --arg sig "$SIG_MAC_ARM" \
            '.platforms["darwin-aarch64"] = {"url": $url, "signature": $sig}' \
            latest.json > tmp.json && mv tmp.json latest.json
        fi
        
        # Add macOS Intel platform if signature exists
        if [ -n "$SIG_MAC_INTEL" ]; then
          MAC_INTEL_URL="${CDN_BASE}/Vibe_Manager_${APP_VERSION}_x86_64-apple-darwin.app.tar.gz"
          jq --arg url "$MAC_INTEL_URL" --arg sig "$SIG_MAC_INTEL" \
            '.platforms["darwin-x86_64"] = {"url": $url, "signature": $sig}' \
            latest.json > tmp.json && mv tmp.json latest.json
        fi
        
        # Substitute variables in the JSON
        envsubst < latest.json > final-latest.json
        
        # Validate JSON structure
        jq -e '.version and .pub_date and .platforms' final-latest.json >/dev/null
        
        # Show what we're uploading (for debugging)
        echo "Generated latest.json:"
        cat final-latest.json
        
        # Upload to S3
        aws s3 cp final-latest.json s3://vibemanager.app/latest.json --content-type "application/json"
        echo "latest.json uploaded successfully"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-central-1