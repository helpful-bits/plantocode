name: Build Desktop Apps with Updater Artifacts

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-windows:
    name: Build Windows with Updater Artifacts
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        run_install: false
      
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        target: x86_64-pc-windows-msvc
        override: true
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          desktop/src-tauri/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Install dependencies
      run: |
        cd desktop
        pnpm install
      
    - name: Build frontend
      run: |
        cd desktop
        pnpm run build
      
    - name: Install Tauri CLI
      run: cargo install tauri-cli --version "^2.0" --locked
      
    - name: Build Windows app with updater artifacts
      run: |
        cd desktop
        cargo tauri build --target x86_64-pc-windows-msvc
      env:
        TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        
    - name: Upload Windows artifacts (for manual S3 upload)
      uses: actions/upload-artifact@v4
      with:
        name: windows-updater-artifacts-${{ github.sha }}
        path: |
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi.zip
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi.zip.sig
        retention-days: 30
        if-no-files-found: warn

  build-macos:
    name: Build macOS with Updater Artifacts
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        run_install: false
      
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        target: x86_64-apple-darwin
        override: true
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          desktop/src-tauri/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Install dependencies
      run: |
        cd desktop
        pnpm install
      
    - name: Build frontend
      run: |
        cd desktop
        pnpm run build
      
    - name: Install Tauri CLI
      run: cargo install tauri-cli --version "^2.0" --locked
      
    - name: Build macOS app with updater artifacts
      run: |
        cd desktop
        cargo tauri build --target x86_64-apple-darwin
      env:
        TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        
    - name: Upload macOS artifacts (for manual S3 upload)
      uses: actions/upload-artifact@v4
      with:
        name: macos-updater-artifacts-${{ github.sha }}
        path: |
          desktop/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
          desktop/src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz
          desktop/src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz.sig
        retention-days: 30
        if-no-files-found: warn