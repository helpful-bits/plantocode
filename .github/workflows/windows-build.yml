name: Build Windows App for Microsoft Store

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-windows:
    name: Build Windows MSI for Microsoft Store
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        run_install: false
      
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        target: x86_64-pc-windows-msvc
        override: true
        
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          desktop/src-tauri/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Install frontend dependencies
      run: |
        cd desktop
        pnpm install --frozen-lockfile
      
    - name: Build frontend
      run: |
        cd desktop
        pnpm run build
      
    - name: Install Tauri CLI
      run: cargo install tauri-cli --version "^2.0" --locked
      
    - name: Build Tauri app for Microsoft Store
      run: |
        cd desktop
        # Build for Microsoft Store (MSI format with offline WebView2)
        cargo tauri build --target x86_64-pc-windows-msvc --config src-tauri/tauri.microsoftstore.conf.json
      env:
        TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        
    - name: Find and display build artifacts
      shell: powershell
      run: |
        Write-Host "=== Build Artifacts ==="
        $bundleDir = "desktop\src-tauri\target\x86_64-pc-windows-msvc\release\bundle"
        
        if (Test-Path $bundleDir) {
          Get-ChildItem -Recurse $bundleDir | Where-Object { $_.Extension -in @('.msi', '.exe') } | ForEach-Object {
            Write-Host "Found: $($_.FullName)"
            Write-Host "Size: $([math]::Round($_.Length / 1MB, 2)) MB"
            Write-Host "---"
          }
        } else {
          Write-Host "Bundle directory not found at: $bundleDir"
          Write-Host "Available directories:"
          Get-ChildItem -Recurse desktop\src-tauri\target -Directory | Select-Object FullName
        }
        
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-app-${{ github.sha }}
        path: |
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/*.exe
        retention-days: 30
        if-no-files-found: warn
        
    - name: Create release (on tags)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
        draft: true
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}