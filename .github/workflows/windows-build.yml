name: Build Desktop Apps with Updater Artifacts

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
    paths:
      - 'desktop/**'
      - 'server/**'
      - '.github/workflows/windows-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'desktop/**'
      - 'server/**'
      - '.github/workflows/windows-build.yml'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  build-windows:
    name: Build Windows with Updater Artifacts
    runs-on: windows-latest  # GitHub default runner
    # FAST ALTERNATIVES (Windows runners that actually work):
    # runs-on: depot-windows-32vcpu-x64          # Depot: 32 vCPU, 4x cheaper - sign up at depot.dev
    # runs-on: runson-windows-x64-4cpu           # RunsOn: Self-hosted in your AWS - runs-on.com
    # 
    # DON'T WORK FOR WINDOWS:
    # BuildJet: Linux/Ubuntu only, no Windows support
    # WarpBuild: Windows support "coming soon" (not available yet)
    # Namespace: No Windows support
    # Blacksmith: No Windows support
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        run_install: false
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
      
    - name: Install Rust toolchain
      run: rustup toolchain install stable --profile minimal --target x86_64-pc-windows-msvc
        
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "desktop/src-tauri -> target"
        cache-targets: "true"
        cache-on-failure: "false"
        prefix-key: "v1-rust-windows"
          
    - name: Install dependencies
      run: |
        cd desktop
        pnpm install
      
    - name: Build frontend
      run: |
        cd desktop
        pnpm run build
      
    - name: Cache Tauri CLI
      id: cache-tauri
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-tauri
        key: ${{ runner.os }}-tauri-cli-2.0
        
    - name: Install Tauri CLI
      if: steps.cache-tauri.outputs.cache-hit != 'true'
      run: cargo install tauri-cli --version "^2.0" --locked
      
    - name: Build Windows app with updater artifacts
      run: |
        cd desktop
        cargo tauri build --target x86_64-pc-windows-msvc
      env:
        TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        
    - name: Upload Windows artifacts (for manual S3 upload)
      uses: actions/upload-artifact@v4
      with:
        name: windows-updater-artifacts-${{ github.sha }}
        path: |
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi.zip
          desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi.zip.sig
        retention-days: 30
        if-no-files-found: warn

  build-macos:
    name: Build macOS with Updater Artifacts
    runs-on: macos-latest  # GitHub default runner (sufficient for macOS)
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        run_install: false
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
      
    - name: Install Rust toolchain
      run: rustup toolchain install stable --profile minimal --target x86_64-apple-darwin
    
    - name: Install OpenSSL for cross-compilation
      run: |
        brew install openssl@3
        echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig" >> $GITHUB_ENV
        
    - name: Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "desktop/src-tauri -> target"
        cache-targets: "true"
        cache-on-failure: "false"
        prefix-key: "v1-rust-macos"
          
    - name: Install dependencies
      run: |
        cd desktop
        pnpm install
      
    - name: Build frontend
      run: |
        cd desktop
        pnpm run build
      
    - name: Cache Tauri CLI
      id: cache-tauri
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-tauri
        key: ${{ runner.os }}-tauri-cli-2.0
        
    - name: Install Tauri CLI
      if: steps.cache-tauri.outputs.cache-hit != 'true'
      run: cargo install tauri-cli --version "^2.0" --locked
      
    - name: Build macOS app with updater artifacts
      run: |
        cd desktop
        cargo tauri build --target x86_64-apple-darwin
      env:
        TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        OPENSSL_DIR: ${{ env.OPENSSL_DIR }}
        PKG_CONFIG_PATH: ${{ env.PKG_CONFIG_PATH }}
        
    - name: Upload macOS artifacts (for manual S3 upload)
      uses: actions/upload-artifact@v4
      with:
        name: macos-updater-artifacts-${{ github.sha }}
        path: |
          desktop/src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
          desktop/src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz
          desktop/src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz.sig
        retention-days: 30
        if-no-files-found: warn