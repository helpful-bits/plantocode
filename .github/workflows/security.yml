name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  rust-security:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
    
    - name: Cache cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          server/target/
        key: ${{ runner.os }}-cargo-security-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-security-
          ${{ runner.os }}-cargo-

    - name: Install cargo-audit
      run: cargo install --force cargo-audit
      
    - name: Install cargo-deny
      run: cargo install --force cargo-deny
      
    - name: Run cargo audit (Rust vulnerability scanning)
      working-directory: server
      run: |
        echo "Running cargo audit to check for known security vulnerabilities..."
        cargo audit --json > audit-results.json || echo "Audit found issues"
        
        # Parse and format results
        if [ -s audit-results.json ]; then
          echo "## ðŸ” Cargo Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if vulnerabilities were found
          if jq -e '.vulnerabilities.found | length > 0' audit-results.json > /dev/null; then
            echo "âŒ **Vulnerabilities Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "```json" >> $GITHUB_STEP_SUMMARY
            jq '.vulnerabilities.list[]' audit-results.json >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **No vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âœ… **No vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Run cargo deny (License and security policy enforcement)
      working-directory: server
      run: |
        echo "Running cargo deny for license and security policy checks..."
        
        # Create deny.toml if it doesn't exist
        if [ ! -f deny.toml ]; then
          cat > deny.toml << 'EOF'
        [licenses]
        # List of explicitly allowed licenses
        allow = [
            "MIT",
            "Apache-2.0",
            "Apache-2.0 WITH LLVM-exception",
            "BSD-2-Clause",
            "BSD-3-Clause",
            "ISC",
            "Unicode-DFS-2016",
            "CC0-1.0",
        ]
        # Confidence threshold for detecting a license from license text
        confidence-threshold = 0.8
        
        [bans]
        # Lint level for when multiple versions of the same crate are detected
        multiple-versions = "warn"
        # List of crates that are allowed to have multiple versions
        skip = [
            { name = "syn", version = "*" },
            { name = "windows_x86_64_msvc", version = "*" },
            { name = "windows_x86_64_gnu", version = "*" },
        ]
        
        [advisories]
        # The path where the advisory database is cloned/fetched into
        db-path = "~/.cargo/advisory-db"
        # The url(s) of the advisory databases to use
        db-urls = ["https://github.com/rustsec/advisory-db"]
        # The lint level for security vulnerabilities
        vulnerability = "deny"
        # The lint level for unmaintained crates
        unmaintained = "warn"
        # The lint level for crates that have been yanked from their source registry
        yanked = "warn"
        # The lint level for crates with security notices
        notice = "warn"
        # A list of advisory IDs to ignore
        ignore = []
        
        [sources]
        # Lint level for what to happen when a crate from a crate registry that is not in the allow list is encountered
        unknown-registry = "warn"
        # Lint level for what to happen when a crate from a git repository that is not in the allow list is encountered
        unknown-git = "warn"
        allow-registry = ["https://github.com/rust-lang/crates.io-index"]
        allow-git = []
        EOF
        fi
        
        cargo deny check --format json > deny-results.json || echo "Deny found issues"
        
        # Parse and format results
        echo "## ðŸš« Cargo Deny Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if grep -q '"type":"error"' deny-results.json 2>/dev/null; then
          echo "âŒ **Policy violations found**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```json" >> $GITHUB_STEP_SUMMARY
          jq '.[] | select(.type == "error")' deny-results.json 2>/dev/null || echo "Error parsing results" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… **No policy violations found**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Rust security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: rust-security-results
        path: |
          server/audit-results.json
          server/deny-results.json
        retention-days: 30

  nodejs-security:
    name: Node.js Security Audit  
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'desktop/pnpm-lock.yaml'
        
    - name: Install pnpm
      run: npm install -g pnpm
      
    - name: Install dependencies
      working-directory: desktop
      run: pnpm install --frozen-lockfile
      
    - name: Run npm audit (Node.js vulnerability scanning)
      working-directory: desktop
      run: |
        echo "Running npm audit for Node.js dependency vulnerabilities..."
        
        # Run audit and capture output
        pnpm audit --audit-level=high --json > audit-results.json || echo "Audit found issues"
        
        # Parse and format results
        echo "## ðŸ“¦ NPM Audit Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if any high/critical vulnerabilities were found
        if [ -s audit-results.json ]; then
          high_vulns=$(jq -r '.metadata.vulnerabilities.high // 0' audit-results.json 2>/dev/null || echo "0")
          critical_vulns=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-results.json 2>/dev/null || echo "0")
          
          if [ "$high_vulns" -gt 0 ] || [ "$critical_vulns" -gt 0 ]; then
            echo "âŒ **High/Critical vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
            echo "- High: $high_vulns" >> $GITHUB_STEP_SUMMARY  
            echo "- Critical: $critical_vulns" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show advisory details
            echo "### Vulnerability Details:" >> $GITHUB_STEP_SUMMARY
            echo "```json" >> $GITHUB_STEP_SUMMARY
            jq '.advisories' audit-results.json 2>/dev/null || echo "Error parsing advisories" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **No high/critical vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âœ… **No vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload Node.js security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nodejs-security-results
        path: desktop/audit-results.json
        retention-days: 30

  eslint-security:
    name: ESLint Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'desktop/pnpm-lock.yaml'
        
    - name: Install pnpm
      run: npm install -g pnpm
      
    - name: Install dependencies
      working-directory: desktop
      run: pnpm install --frozen-lockfile
      
    - name: Run ESLint security rules
      working-directory: desktop
      run: |
        echo "Running ESLint with security-focused rules..."
        
        # Run security linting
        pnpm run lint:security --format json > eslint-security-results.json || echo "ESLint found security issues"
        
        # Parse and format results
        echo "## ðŸ”’ ESLint Security Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -s eslint-security-results.json ]; then
          error_count=$(jq '[.[] | .errorCount] | add // 0' eslint-security-results.json)
          warning_count=$(jq '[.[] | .warningCount] | add // 0' eslint-security-results.json)
          
          if [ "$error_count" -gt 0 ]; then
            echo "âŒ **Security errors found: $error_count**" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Security warnings found: $warning_count**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show error details
            echo "### Security Issues:" >> $GITHUB_STEP_SUMMARY
            echo "```json" >> $GITHUB_STEP_SUMMARY
            jq '[.[] | select(.errorCount > 0) | .messages[]]' eslint-security-results.json >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "$warning_count" -gt 0 ]; then
            echo "âš ï¸ **Security warnings found: $warning_count**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "```json" >> $GITHUB_STEP_SUMMARY
            jq '[.[] | select(.warningCount > 0) | .messages[]]' eslint-security-results.json >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No security issues found**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âœ… **No security issues found**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload ESLint security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: eslint-security-results
        path: desktop/eslint-security-results.json
        retention-days: 30

  tauri-security:
    name: Tauri Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'desktop/pnpm-lock.yaml'
        
    - name: Install pnpm
      run: npm install -g pnpm
      
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
        
    - name: Install dependencies
      working-directory: desktop
      run: pnpm install --frozen-lockfile
      
    - name: Install Tauri CLI
      run: cargo install tauri-cli --version "^2.0" --locked
      
    - name: Audit Tauri configuration
      working-directory: desktop
      run: |
        echo "Auditing Tauri configuration for security issues..."
        
        # Check for common security misconfigurations
        CONFIG_FILE="src-tauri/tauri.conf.json"
        
        echo "## ðŸ”§ Tauri Security Configuration Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check CSP configuration
        if jq -e '.app.security.csp == null' "$CONFIG_FILE" > /dev/null; then
          echo "âš ï¸ **CSP Warning**: Content Security Policy is disabled" >> $GITHUB_STEP_SUMMARY
          echo "- Consider enabling CSP for additional security" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **CSP**: Content Security Policy is configured" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check for dangerous permissions in Windows MSIX capabilities
        if jq -e '.bundle.windows.msix.capabilities | contains(["allFileSystemAccess"])' "$CONFIG_FILE" > /dev/null; then
          echo "âŒ **Dangerous Permission**: allFileSystemAccess detected" >> $GITHUB_STEP_SUMMARY
          echo "- Review if full filesystem access is necessary" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check for sensitive capabilities
        if jq -e '.bundle.windows.msix.capabilities | contains(["runFullTrust"])' "$CONFIG_FILE" > /dev/null; then
          echo "âš ï¸ **High Privilege**: runFullTrust capability detected" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure this level of access is required for app functionality" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check security capabilities configuration
        if jq -e '.app.security.capabilities' "$CONFIG_FILE" > /dev/null; then
          echo "âœ… **Capabilities**: Security capabilities are configured" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Capabilities Warning**: No security capabilities configuration found" >> $GITHUB_STEP_SUMMARY
          echo "- Consider restricting available APIs via capabilities" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check for macOSPrivateApi usage
        if jq -e '.app.macOSPrivateApi == true' "$CONFIG_FILE" > /dev/null; then
          echo "âš ï¸ **macOS Private API**: Private API usage enabled" >> $GITHUB_STEP_SUMMARY
          echo "- This may cause App Store rejection for macOS builds" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check withGlobalTauri setting
        if jq -e '.app.withGlobalTauri == true' "$CONFIG_FILE" > /dev/null; then
          echo "âš ï¸ **Global Tauri**: Global Tauri object enabled" >> $GITHUB_STEP_SUMMARY
          echo "- Consider disabling for better security isolation" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Global Tauri**: Global Tauri object is disabled" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Check for sensitive files in bundle
      working-directory: desktop
      run: |
        echo "Checking for sensitive files that might be included in bundle..."
        
        # List of sensitive patterns to check for
        SENSITIVE_PATTERNS=(".env" "*.key" "*.pem" "*.p12" ".secrets" "config/*.json")
        
        echo "## ðŸ” Sensitive Files Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        found_sensitive=false
        for pattern in "${SENSITIVE_PATTERNS[@]}"; do
          if find . -name "$pattern" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./src-tauri/target/*" | grep -q .; then
            echo "âš ï¸ **Found sensitive files matching**: $pattern" >> $GITHUB_STEP_SUMMARY
            find . -name "$pattern" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./src-tauri/target/*" >> $GITHUB_STEP_SUMMARY
            found_sensitive=true
          fi
        done
        
        if [ "$found_sensitive" = false ]; then
          echo "âœ… **No sensitive files found in repository**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Validate Tauri capabilities
      working-directory: desktop
      run: |
        echo "Validating Tauri capabilities configuration..."
        
        echo "## ðŸ›¡ï¸ Tauri Capabilities Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if capability files exist
        if [ -d "src-tauri/capabilities" ]; then
          echo "âœ… **Capabilities directory found**" >> $GITHUB_STEP_SUMMARY
          
          # List all capability files
          for cap_file in src-tauri/capabilities/*.json; do
            if [ -f "$cap_file" ]; then
              cap_name=$(basename "$cap_file" .json)
              echo "- Found capability: $cap_name" >> $GITHUB_STEP_SUMMARY
              
              # Validate JSON format
              if jq empty "$cap_file" 2>/dev/null; then
                echo "  âœ… Valid JSON format" >> $GITHUB_STEP_SUMMARY
              else
                echo "  âŒ Invalid JSON format in $cap_file" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
        else
          echo "âš ï¸ **No capabilities directory found**" >> $GITHUB_STEP_SUMMARY
          echo "- Consider creating capability files for better security" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Check Rust dependencies security
      working-directory: desktop/src-tauri
      run: |
        echo "Running cargo audit on Tauri Rust dependencies..."
        
        # Install cargo-audit if not present
        cargo install --force cargo-audit
        
        # Run audit and capture output
        cargo audit --json > tauri-audit-results.json || echo "Audit found issues"
        
        echo "## ðŸ¦€ Tauri Rust Dependencies Audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Parse and format results
        if [ -s tauri-audit-results.json ]; then
          # Check if vulnerabilities were found
          if jq -e '.vulnerabilities.found | length > 0' tauri-audit-results.json > /dev/null; then
            echo "âŒ **Tauri Rust Vulnerabilities Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "```json" >> $GITHUB_STEP_SUMMARY
            jq '.vulnerabilities.list[]' tauri-audit-results.json >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No Tauri Rust vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âœ… **No Tauri Rust vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload Tauri security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: tauri-security-results
        path: |
          desktop/src-tauri/tauri-audit-results.json
        retention-days: 30

  property-tests:
    name: Property-Based Security Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_vibe_manager
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
        
    - name: Cache cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          server/target/
        key: ${{ runner.os }}-cargo-tests-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-tests-
          ${{ runner.os }}-cargo-
          
    - name: Setup test database
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_vibe_manager
      working-directory: server
      run: |
        # Install sqlx-cli for database migrations
        cargo install sqlx-cli --no-default-features --features postgres
        
        # Run migrations to set up test database
        sqlx database create || echo "Database already exists"
        sqlx migrate run --source migrations
        
    - name: Run property-based billing tests
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_vibe_manager
        RUST_LOG: debug
      working-directory: server
      run: |
        echo "Running comprehensive property-based billing security tests..."
        
        # Run the billing consistency tests with verbose output
        cargo test billing_consistency_tests --release --verbose -- --nocapture --test-threads=1
        
        echo "## ðŸ§ª Property-Based Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **All billing invariant tests passed**" >> $GITHUB_STEP_SUMMARY
        echo "- Negative balance prevention verified" >> $GITHUB_STEP_SUMMARY
        echo "- Transaction atomicity confirmed" >> $GITHUB_STEP_SUMMARY
        echo "- Concurrent operation safety validated" >> $GITHUB_STEP_SUMMARY
        echo "- Global consistency maintained under load" >> $GITHUB_STEP_SUMMARY

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [rust-security, nodejs-security, eslint-security, tauri-security, property-tests]
    if: always()
    
    steps:
    - name: Generate security summary
      run: |
        echo "# ðŸ” Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check job statuses
        rust_status="${{ needs.rust-security.result }}"
        nodejs_status="${{ needs.nodejs-security.result }}"
        eslint_status="${{ needs.eslint-security.result }}"
        tauri_status="${{ needs.tauri-security.result }}"
        tests_status="${{ needs.property-tests.result }}"
        
        echo "## Scan Results:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Format results with emoji indicators
        case $rust_status in
          "success") echo "âœ… **Rust Security**: No vulnerabilities found" >> $GITHUB_STEP_SUMMARY ;;
          "failure") echo "âŒ **Rust Security**: Vulnerabilities detected" >> $GITHUB_STEP_SUMMARY ;;
          *) echo "âš ï¸ **Rust Security**: Scan incomplete" >> $GITHUB_STEP_SUMMARY ;;
        esac
        
        case $nodejs_status in
          "success") echo "âœ… **Node.js Security**: No high/critical vulnerabilities" >> $GITHUB_STEP_SUMMARY ;;
          "failure") echo "âŒ **Node.js Security**: Vulnerabilities detected" >> $GITHUB_STEP_SUMMARY ;;
          *) echo "âš ï¸ **Node.js Security**: Scan incomplete" >> $GITHUB_STEP_SUMMARY ;;
        esac
        
        case $eslint_status in
          "success") echo "âœ… **ESLint Security**: No security issues found" >> $GITHUB_STEP_SUMMARY ;;
          "failure") echo "âŒ **ESLint Security**: Security issues detected" >> $GITHUB_STEP_SUMMARY ;;
          *) echo "âš ï¸ **ESLint Security**: Scan incomplete" >> $GITHUB_STEP_SUMMARY ;;
        esac
        
        case $tauri_status in
          "success") echo "âœ… **Tauri Security**: Configuration and dependencies secure" >> $GITHUB_STEP_SUMMARY ;;
          "failure") echo "âŒ **Tauri Security**: Security issues detected" >> $GITHUB_STEP_SUMMARY ;;
          *) echo "âš ï¸ **Tauri Security**: Scan incomplete" >> $GITHUB_STEP_SUMMARY ;;
        esac
        
        case $tests_status in
          "success") echo "âœ… **Property Tests**: All billing invariants verified" >> $GITHUB_STEP_SUMMARY ;;
          "failure") echo "âŒ **Property Tests**: Security invariants violated" >> $GITHUB_STEP_SUMMARY ;;
          *) echo "âš ï¸ **Property Tests**: Tests incomplete" >> $GITHUB_STEP_SUMMARY ;;
        esac
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Recommendations:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Provide actionable recommendations based on results
        if [ "$rust_status" = "failure" ] || [ "$nodejs_status" = "failure" ] || [ "$tauri_status" = "failure" ]; then
          echo "ðŸš¨ **Immediate Action Required**: Critical vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
          echo "- Review and update vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- Check security advisories for affected packages" >> $GITHUB_STEP_SUMMARY
          echo "- Consider temporary mitigations if updates unavailable" >> $GITHUB_STEP_SUMMARY
        elif [ "$eslint_status" = "failure" ]; then
          echo "âš ï¸ **Code Review Recommended**: Security code patterns detected" >> $GITHUB_STEP_SUMMARY
          echo "- Review flagged code for potential security issues" >> $GITHUB_STEP_SUMMARY
          echo "- Update code to follow security best practices" >> $GITHUB_STEP_SUMMARY
        elif [ "$tests_status" = "failure" ]; then
          echo "ðŸ”¥ **Critical**: Financial security invariants violated" >> $GITHUB_STEP_SUMMARY
          echo "- DO NOT DEPLOY until billing logic is fixed" >> $GITHUB_STEP_SUMMARY
          echo "- Review credit transaction logic for race conditions" >> $GITHUB_STEP_SUMMARY
          echo "- Verify database constraints are properly enforced" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **All Clear**: No security issues detected" >> $GITHUB_STEP_SUMMARY
          echo "- Continue with regular development workflow" >> $GITHUB_STEP_SUMMARY
          echo "- Consider running additional manual security testing" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Set exit code based on critical failures
        if [ "$rust_status" = "failure" ] || [ "$nodejs_status" = "failure" ] || [ "$tauri_status" = "failure" ] || [ "$tests_status" = "failure" ]; then
          echo "âŒ Security gate failed - blocking deployment" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi