import { useState } from "react";
import { Loader2, ChevronDown, ChevronUp, Copy, Eye } from "lucide-react";
import { useNotification } from "@/contexts/notification-context";

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/ui/card";
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/ui/collapsible";
import { Progress } from "@/ui/progress";
import { VirtualizedCodeViewer } from "@/ui/virtualized-code-viewer";
import { useJobDetailsContext } from "../../_contexts/job-details-context";
import { parsePlanResponseContent } from "../../../implementation-plans-panel/_utils/plan-content-parser";
import { Button } from "@/ui/button";
import { replacePlaceholders } from "@/utils/placeholder-utils";
import { type CopyButtonConfig } from "@/types/config-types";
import PlanContentModal from "../../../implementation-plans-panel/_components/PlanContentModal";

import { getStreamingProgressValue } from "../../utils";

export function JobDetailsResponseSection() {
  const { job, responseContent, parsedMetadata, copyButtons = [] } = useJobDetailsContext();
  const [isResponseOpen, setIsResponseOpen] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const { showNotification } = useNotification();

  const isImplementationPlan = job.taskType === "implementation_plan";

  let displayContentForViewer = responseContent || "";
  let viewerLanguage = "markdown"; // Default for most jobs

  const isJobStreaming = (job.status === "running" || job.status === "processingStream") && Boolean(parsedMetadata?.taskData?.isStreaming);

  if (job.taskType === "implementation_plan") {
    viewerLanguage = "xml"; // Implementation plans are expected to be XML
    if (!isJobStreaming && job.status === "completed") {
      displayContentForViewer = parsePlanResponseContent(responseContent);
    }
    // For streaming or other states of implementation_plan, responseContent (raw job.response) is used directly.
  }


  // Copy handler for modal - simplified since PlanContentModal handles the logic
  const handleCopy = async (button: CopyButtonConfig) => {
    try {
      const data = { IMPLEMENTATION_PLAN: displayContentForViewer, STEP_CONTENT: '' };
      const processedContent = replacePlaceholders(button.content, data);
      await navigator.clipboard.writeText(processedContent);
      
      showNotification({
        title: "Copied to clipboard",
        message: `${button.label} copied successfully`,
        type: "success",
        duration: 2000,
      });
    } catch (err) {
      console.error("Failed to copy to clipboard:", err);
      showNotification({
        title: "Copy failed", 
        message: "Failed to copy to clipboard",
        type: "error",
        duration: 3000,
      });
    }
  };

  return (
    <Card>
      {isImplementationPlan ? (
        // For implementation plans: header with copy buttons and modal trigger
        <CardHeader className="py-4 px-6">
          <div className="flex justify-between items-center">
            <div>
              <CardTitle className="text-sm font-semibold flex items-center gap-2 transition-colors">
                <span>Content</span>
                {isJobStreaming && (
                  <div className="flex items-center gap-1">
                    <Loader2 className="h-3 w-3 animate-spin" />
                    <span className="text-xs">Live Updates</span>
                  </div>
                )}
              </CardTitle>
              <CardDescription className="text-sm text-muted-foreground/80 mt-1">
                Output generated by the AI model
              </CardDescription>
            </div>
            <div className="flex items-center gap-2">
              {/* Copy Buttons */}
              {copyButtons.length > 0 && !isJobStreaming && (
                <div className="flex items-center gap-1">
                  {copyButtons.map((button) => (
                    <Button
                      key={button.id}
                      variant="outline"
                      size="sm"
                      className="text-xs h-7 px-2 py-1"
                      onClick={(e) => {
                        e.stopPropagation();
                        handleCopy(button);
                      }}
                      title={`Copy: ${button.label}`}
                    >
                      <Copy className="mr-1 h-3 w-3" />
                      {button.label}
                    </Button>
                  ))}
                </div>
              )}
              {/* View Content Button */}
              <Button
                variant="outline"
                size="sm"
                className="text-xs h-7 px-2 py-1"
                onClick={() => setIsModalOpen(true)}
              >
                <Eye className="mr-1 h-3.5 w-3.5" />
                View Content
              </Button>
            </div>
          </div>
        </CardHeader>
      ) : (
        // For other job types: normal accordion behavior
        <Collapsible open={isResponseOpen} onOpenChange={setIsResponseOpen}>
          <CollapsibleTrigger asChild>
            <CardHeader className="py-4 px-6 cursor-pointer hover:bg-accent/30 transition-all duration-200 rounded-t-xl group">
              <div className="flex justify-between items-center">
                <div>
                  <CardTitle className="text-sm font-semibold flex items-center gap-2 group-hover:text-foreground/80 transition-colors">
                    <span>Response</span>
                  </CardTitle>
                  <CardDescription className="text-sm text-muted-foreground/80 mt-1">
                    Output generated by the AI model
                  </CardDescription>
                </div>
                <div className="flex items-center gap-2">
                  {isResponseOpen ? <ChevronUp className="h-5 w-5 text-muted-foreground group-hover:text-foreground transition-colors" /> : <ChevronDown className="h-5 w-5 text-muted-foreground group-hover:text-foreground transition-colors" />}
                </div>
              </div>
            </CardHeader>
          </CollapsibleTrigger>

          <CollapsibleContent>
            <CardContent className="pt-0">
              {(job.status === "running" || job.status === "processingStream") && parsedMetadata?.taskData?.isStreaming ? (
                <div className="mb-3">
                  <Progress
                    value={
                      getStreamingProgressValue(
                        job.metadata,
                        job.startTime
                      ) ?? 10
                    }
                    className="h-1 mb-2"
                  />
                  <div className="flex justify-between items-center text-xs text-muted-foreground">
                    <div className="flex items-center gap-2">
                      <Loader2 className="h-3 w-3 animate-spin text-info" />
                      <span className="text-info font-medium">
                        Streaming in progress...
                      </span>
                    </div>
                    <div className="flex items-center gap-2">
                      {parsedMetadata?.taskData?.responseLength ? (
                        <span>
                          {Math.floor(Number(parsedMetadata.taskData.responseLength) / 1024)} KB received
                        </span>
                      ) : null}
                      {typeof parsedMetadata?.taskData?.streamProgress === "number" && (
                        <span>{Math.floor(parsedMetadata.taskData.streamProgress)}% complete</span>
                      )}
                    </div>
                  </div>
                </div>
              ) : null}

              <VirtualizedCodeViewer
                content={displayContentForViewer}
                language={viewerLanguage}
                height="70vh"
                showCopy={true}
                copyText="Copy response"
                showContentSize={true}
                isLoading={isJobStreaming}
                placeholder="No response content available"
                className={
                  job.taskType === "extended_path_finder" || job.taskType === "regex_file_filter"
                    ? "border-border/60 bg-slate-50/50 dark:bg-slate-900/50"
                    : undefined
                }
                loadingIndicator={
                  <div className="flex items-center justify-center h-full">
                    <div className="flex items-center gap-2">
                      <Loader2 className="h-4 w-4 animate-spin text-info" />
                      <span className="text-sm text-info">Streaming response...</span>
                    </div>
                  </div>
                }
              />
            </CardContent>
          </CollapsibleContent>
        </Collapsible>
      )}

      {/* Content View Modal */}
      <PlanContentModal
        plan={job}
        open={isModalOpen}
        onOpenChange={setIsModalOpen}
        onRefreshContent={async () => {
          // No refresh needed in this context as job data comes from context
        }}
        copyButtons={copyButtons}
        onCopyButtonClick={(buttonConfig) => handleCopy(buttonConfig)}
      />
    </Card>
  );
}
