import { useState } from "react";
import { Loader2, ChevronDown, ChevronUp, Copy } from "lucide-react";
import { useNotification } from "@/contexts/notification-context";

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/ui/card";
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/ui/collapsible";
import { Progress } from "@/ui/progress";
import { VirtualizedCodeViewer } from "@/ui/virtualized-code-viewer";
import { useJobDetailsContext } from "../../_contexts/job-details-context";
import { parsePlanResponseContent, extractStepsFromPlan, getContentForStep } from "../../../implementation-plans-panel/_utils/plan-content-parser";
import { Button } from "@/ui/button";
import { replacePlaceholders } from "@/utils/placeholder-utils";
import { type CopyButtonConfig } from "@/types/config-types";

import { getStreamingProgressValue } from "../../utils";

export function JobDetailsResponseSection() {
  const { job, responseContent, parsedMetadata, copyButtons = [] } = useJobDetailsContext();
  const [isResponseOpen, setIsResponseOpen] = useState(false);
  const [selectedStepNumber, setSelectedStepNumber] = useState<string | null>(null);
  const { showNotification } = useNotification();

  let displayContentForViewer = responseContent || "";
  let viewerLanguage = "markdown"; // Default for most jobs

  const isJobStreaming = (job.status === "running" || job.status === "processingStream") && Boolean(parsedMetadata?.taskData?.isStreaming);

  if (job.taskType === "implementation_plan") {
    viewerLanguage = "xml"; // Implementation plans are expected to be XML
    if (!isJobStreaming && job.status === "completed") {
      displayContentForViewer = parsePlanResponseContent(responseContent);
    }
    // For streaming or other states of implementation_plan, responseContent (raw job.response) is used directly.
  }

  // Extract steps for implementation plans
  const steps = job.taskType === "implementation_plan" ? extractStepsFromPlan(responseContent) : [];


  // Generic copy handler using replacePlaceholders utility
  const handleCopy = async (button: CopyButtonConfig) => {
    try {
      const stepContent = job.taskType === 'implementation_plan' && selectedStepNumber ? getContentForStep(displayContentForViewer, selectedStepNumber) : '';
      const data = { RESPONSE: displayContentForViewer, STEP_CONTENT: stepContent };
      
      const processedContent = replacePlaceholders(button.content, data);
      await navigator.clipboard.writeText(processedContent);
      
      showNotification({
        title: "Copied to clipboard",
        message: `${button.label} copied successfully`,
        type: "success",
        duration: 2000,
      });
    } catch (err) {
      console.error("Failed to copy to clipboard:", err);
      showNotification({
        title: "Copy failed",
        message: "Failed to copy to clipboard",
        type: "error",
        duration: 3000,
      });
    }
  };

  return (
    <Card>
      <Collapsible open={isResponseOpen} onOpenChange={setIsResponseOpen}>
        <CollapsibleTrigger asChild>
          <CardHeader className="py-4 px-6 cursor-pointer hover:bg-accent/30 transition-all duration-200 rounded-t-xl group">
            <div className="flex justify-between items-center">
              <div>
                <CardTitle className="text-sm font-semibold flex items-center gap-2 group-hover:text-foreground/80 transition-colors">
                  {job.taskType === "implementation_plan" ? (
                    <>
                      <span>Content</span>
                      {isJobStreaming && (
                        <div className="flex items-center gap-1">
                          <Loader2 className="h-3 w-3 animate-spin" />
                          <span className="text-xs">Live Updates</span>
                        </div>
                      )}
                    </>
                  ) : (
                    <span>Response</span>
                  )}
                </CardTitle>
                <CardDescription className="text-sm text-muted-foreground/80 mt-1">
                  Output generated by the AI model
                </CardDescription>
              </div>
              <div className="flex items-center gap-2">
                {isResponseOpen ? <ChevronUp className="h-5 w-5 text-muted-foreground group-hover:text-foreground transition-colors" /> : <ChevronDown className="h-5 w-5 text-muted-foreground group-hover:text-foreground transition-colors" />}
              </div>
            </div>
          </CardHeader>
        </CollapsibleTrigger>

        <CollapsibleContent>
          <CardContent className="pt-0">
            {(job.status === "running" || job.status === "processingStream") && parsedMetadata?.taskData?.isStreaming ? (
              <div className="mb-3">
                <Progress
                  value={
                    getStreamingProgressValue(
                      job.metadata,
                      job.startTime
                    ) ?? 10
                  }
                  className="h-1 mb-2"
                />
                <div className="flex justify-between items-center text-xs text-muted-foreground">
                  <div className="flex items-center gap-2">
                    <Loader2 className="h-3 w-3 animate-spin text-info" />
                    <span className="text-info font-medium">
                      Streaming in progress...
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    {parsedMetadata?.taskData?.responseLength ? (
                      <span>
                        {Math.floor(Number(parsedMetadata.taskData.responseLength) / 1024)} KB received
                      </span>
                    ) : null}
                    {typeof parsedMetadata?.taskData?.streamProgress === "number" && (
                      <span>{Math.floor(parsedMetadata.taskData.streamProgress)}% complete</span>
                    )}
                  </div>
                </div>
              </div>
            ) : null}


            {/* Step Selection for Implementation Plans */}
            {job.taskType === "implementation_plan" && steps.length > 0 && !isJobStreaming && (
              <div className="mb-3">
                <div className="text-xs text-muted-foreground mb-2">Select content to copy:</div>
                <div className="flex flex-wrap gap-2">
                  <Button
                    variant={selectedStepNumber === null ? "default" : "outline"}
                    size="sm"
                    onClick={() => setSelectedStepNumber(null)}
                    className="text-xs h-7"
                  >
                    Full Plan
                  </Button>
                  {steps.map((step) => (
                    <Button
                      key={step.number}
                      variant={selectedStepNumber === step.number ? "default" : "outline"}
                      size="sm"
                      onClick={() => setSelectedStepNumber(step.number)}
                      className="text-xs h-7"
                      title={step.title}
                    >
                      Step {step.number}
                    </Button>
                  ))}
                </div>
              </div>
            )}

            {/* Generic Copy Buttons */}
            {copyButtons.length > 0 && !isJobStreaming && (
              <div className="mb-3">
                <div className="text-xs text-muted-foreground mb-2">Copy with template:</div>
                <div className="flex flex-wrap gap-2">
                  {copyButtons.map((button) => (
                    <Button
                      key={button.id}
                      variant="outline"
                      size="sm"
                      onClick={() => handleCopy(button)}
                      className="text-xs h-7"
                      title={`Copy: ${button.label}`}
                    >
                      <Copy className="h-3 w-3 mr-1" />
                      {button.label}
                    </Button>
                  ))}
                </div>
              </div>
            )}

              <VirtualizedCodeViewer
                content={displayContentForViewer}
                language={viewerLanguage}
                height="70vh"
                showCopy={job.taskType !== "implementation_plan"}
                copyText={job.taskType === "implementation_plan" ? "Copy content" : "Copy response"}
                showContentSize={true}
                isLoading={isJobStreaming}
                placeholder="No response content available"
                className={
                  job.taskType === "implementation_plan"
                    ? isJobStreaming
                      ? "border-info/60 bg-info/5"
                      : job.status === "completed"
                        ? "border-success/60 bg-success/5"
                        : undefined
                    : job.taskType === "path_finder" || job.taskType === "regex_pattern_generation"
                      ? "border-border/60 bg-slate-50/50 dark:bg-slate-900/50"
                      : undefined
                }
                loadingIndicator={
                  <div className="flex items-center justify-center h-full">
                    <div className="flex items-center gap-2">
                      <Loader2 className="h-4 w-4 animate-spin text-info" />
                      <span className="text-sm text-info">Streaming response...</span>
                    </div>
                  </div>
                }
              />
          </CardContent>
        </CollapsibleContent>
      </Collapsible>
    </Card>
  );
}
