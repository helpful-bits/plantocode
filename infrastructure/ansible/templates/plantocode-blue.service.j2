[Unit]
Description={{ app_name }} Rust Service (Blue)
After=network.target postgresql@17-main.service
Wants=postgresql@17-main.service

[Service]
Type=simple
User={{ app_user }}
Group={{ app_user }}
WorkingDirectory={{ app_dir }}

# Binary path
ExecStart={{ app_dir }}/bin/server

# Environment override for blue instance
Environment="SERVER_PORT=8080"
Environment="DEPLOYMENT_COLOR=blue"
Environment="PLANTOCODE_DEPLOYMENT_TOKEN={{ plantocode_deployment_token }}"

# Graceful reload using symlink switch
ExecReload=/bin/kill -s HUP $MAINPID

# Restart policy
Restart=always
RestartSec=5

# Security hardening
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths={{ app_dir }}/logs /var/log/{{ app_name }}

# Resource limits
LimitNOFILE=65535

# Environment file (contains all other env vars)
EnvironmentFile={{ app_dir }}/config/app.env

# Graceful shutdown timeout - allow long-running streams to complete
TimeoutStopSec=130
KillMode=mixed
KillSignal=SIGTERM
SendSIGKILL=yes

[Install]
WantedBy=multi-user.target
