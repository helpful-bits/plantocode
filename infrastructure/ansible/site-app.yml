---
# PlanToCode Application Deployment
# This playbook handles all application-specific setup and deployment
# Prerequisites: Run site-base.yml first to set up infrastructure

- name: PlanToCode Application Deployment
  hosts: all
  become: yes
  
  tasks:
    - name: Check prerequisites
      block:
        - name: Check if PostgreSQL is running
          systemd:
            name: postgresql@17-main
          register: pg_status
          failed_when: false
          
        - name: Check if Redis is running
          systemd:
            name: redis-server
          register: redis_status
          failed_when: false
          
        - name: Fail if prerequisites not met
          fail:
            msg: |
              Prerequisites not met! Please run base infrastructure setup first:
              ansible-playbook -i inventory/hosts.yml site-base.yml
          when: >
            (pg_status.status.ActiveState | default('inactive') != 'active') or
            (redis_status.status.ActiveState | default('inactive') != 'active')
            
        - name: Prerequisites OK
          debug:
            msg: "âœ“ All prerequisites met. Proceeding with application deployment."

# ========================================
# APPLICATION DEPLOYMENT
# ========================================

# Complete application setup (database, migrations, secrets, deployment)
- import_playbook: playbooks/plantocode/app-setup.yml
  tags: [app, setup]

# Individual application components (for maintenance)
- import_playbook: playbooks/plantocode/database-migrations.yml
  tags: [migrations]


- import_playbook: playbooks/plantocode/rust-deploy.yml
  tags: [deploy]

# ========================================
# WEBSITE DEPLOYMENT
# ========================================
# Note: Website deployment requires region-specific secrets to be loaded
# Run with: ansible-playbook -i inventory/hosts.yml site-app.yml --vault-password-file .vault_pass
- import_playbook: playbooks/website/website-docker-deploy.yml
  tags: [website, deploy]

# ========================================
# APPLICATION MANAGEMENT
# ========================================
- import_playbook: playbooks/plantocode/maintenance.yml
  tags: [status, health, logs, restart, start, stop]