---
# Complete Application Setup for Vibe Manager
# This is the master playbook for all app-specific operations
# Prerequisites: Base infrastructure must be installed (PostgreSQL, Redis, etc.)

- name: Vibe Manager Application Setup
  hosts: all
  become: yes
  vars:
    app_name: vibe-manager
    app_dir: "/opt/{{ app_name }}"
    
  tasks:
    - name: Display setup plan
      debug:
        msg:
          - "=== VIBE MANAGER APPLICATION SETUP ==="
          - "This playbook will:"
          - "1. Create application database and user"
          - "2. Run database migrations"
          - "3. Configure application secrets"
          - "4. Deploy the application binary"
          - "5. Start the application service"
          
# ========================================
# STEP 1: DATABASE SETUP
# ========================================
- name: Application Database Setup
  hosts: all
  become: yes
  vars:
    app_role: vibe_manager_app
    
  tasks:
    - name: Create application database
      community.postgresql.postgresql_db:
        name: "{{ db_name }}"
        encoding: UTF-8
        lc_collate: en_US.UTF-8
        lc_ctype: en_US.UTF-8
        template: template0
        state: present
      become_user: postgres
        
    - name: Create application user
      community.postgresql.postgresql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"
        state: present
      become_user: postgres
      no_log: true
      
    - name: Create application role with no login
      community.postgresql.postgresql_query:
        db: "{{ db_name }}"
        query: "CREATE ROLE {{ app_role }} NOLOGIN"
      become_user: postgres
      ignore_errors: yes # Role may already exist

    - name: Grant database connection to role
      community.postgresql.postgresql_privs:
        db: "{{ db_name }}"
        priv: CONNECT
        type: database
        roles: "{{ app_role }}"
        state: present
      become_user: postgres

    - name: Grant schema usage to role
      community.postgresql.postgresql_privs:
        db: "{{ db_name }}"
        priv: USAGE
        type: schema
        objs: public
        roles: "{{ app_role }}"
        state: present
      become_user: postgres

    - name: Grant all privileges on all tables to role
      community.postgresql.postgresql_privs:
        db: "{{ db_name }}"
        priv: ALL
        type: table
        objs: ALL_IN_SCHEMA
        schema: public
        roles: "{{ app_role }}"
        state: present
      become_user: postgres
      
    - name: Grant all privileges on all sequences to role
      community.postgresql.postgresql_privs:
        db: "{{ db_name }}"
        priv: ALL
        type: sequence
        objs: ALL_IN_SCHEMA
        schema: public
        roles: "{{ app_role }}"
        state: present
      become_user: postgres

    - name: Set default privileges for future objects for the role
      community.postgresql.postgresql_privs:
        db: "{{ db_name }}"
        role: "{{ app_role }}"
        type: default_privs
        privs: ALL
        objs: TABLES
        schema: public
        state: present
      become_user: postgres
        
    - name: Grant application role to application user
      community.postgresql.postgresql_membership:
        group: "{{ app_role }}"
        target_role: "{{ db_user }}"
        state: present
      become_user: postgres

# ========================================
# STEP 2: RUN MIGRATIONS
# ========================================
- import_playbook: database-migrations.yml
  tags: [migrations]

# ========================================
# STEP 3: CONFIGURE SECRETS
# ========================================
# Note: Secrets management removed - manage manually or through external tools

# ========================================
# STEP 4: DEPLOY APPLICATION
# ========================================
- import_playbook: rust-deploy.yml
  tags: [deploy]