---
- name: Redis Setup and Configuration
  hosts: all
  become: yes
  vars:
    redis_version: 7
    redis_port: 6379
    redis_bind_address: "127.0.0.1"
    redis_maxmemory: "4gb"  # Adjust based on your needs (64GB RAM server)
    redis_maxmemory_policy: "allkeys-lru"
    redis_dir: "/var/lib/redis"
    redis_log_dir: "/var/log/redis"
    
  tasks:
    # ========================================
    # REDIS INSTALLATION
    # ========================================
    - name: Install Redis
      tags: [install]
      block:
        - name: Update apt cache
          apt:
            update_cache: yes
            cache_valid_time: 3600
            
        - name: Install Redis server and tools
          apt:
            name:
              - redis-server
              - redis-tools
            state: present
            
        - name: Stop Redis for configuration
          systemd:
            name: redis-server
            state: stopped

    # ========================================
    # REDIS CONFIGURATION
    # ========================================
    - name: Configure Redis
      tags: [configure]
      block:
        - name: Create Redis configuration
          copy:
            dest: /etc/redis/redis.conf
            owner: redis
            group: redis
            mode: '0640'
            backup: yes
            content: |
              # Redis Configuration for {{ ansible_hostname }}
              # Generated by Ansible on {{ ansible_date_time.iso8601 }}
              
              # Network
              bind {{ redis_bind_address }}
              protected-mode yes
              port {{ redis_port }}
              tcp-backlog 511
              timeout 0
              tcp-keepalive 300
              
              # General
              daemonize yes
              supervised systemd
              pidfile /var/run/redis/redis-server.pid
              loglevel notice
              logfile {{ redis_log_dir }}/redis-server.log
              databases 16
              
              # Snapshotting
              save 900 1      # after 900 sec (15 min) if at least 1 key changed
              save 300 10     # after 300 sec (5 min) if at least 10 keys changed
              save 60 10000   # after 60 sec if at least 10000 keys changed
              
              stop-writes-on-bgsave-error yes
              rdbcompression yes
              rdbchecksum yes
              dbfilename dump.rdb
              dir {{ redis_dir }}
              
              # Replication
              replica-read-only yes
              
              # Security
              requirepass {{ redis_password }}
              
              # Memory Management
              maxmemory {{ redis_maxmemory }}
              maxmemory-policy {{ redis_maxmemory_policy }}
              maxmemory-samples 5
              
              # Lazy Freeing
              lazyfree-lazy-eviction no
              lazyfree-lazy-expire no
              lazyfree-lazy-server-del no
              replica-lazy-flush no
              
              # Append Only Mode
              appendonly yes
              appendfilename "appendonly.aof"
              appendfsync everysec
              no-appendfsync-on-rewrite no
              auto-aof-rewrite-percentage 100
              auto-aof-rewrite-min-size 64mb
              
              # Lua Scripting
              lua-time-limit 5000
              
              # Slow Log
              slowlog-log-slower-than 10000
              slowlog-max-len 128
              
              # Event Notification
              notify-keyspace-events ""
              
              # Advanced Config
              hash-max-ziplist-entries 512
              hash-max-ziplist-value 64
              list-max-ziplist-size -2
              list-compress-depth 0
              set-max-intset-entries 512
              zset-max-ziplist-entries 128
              zset-max-ziplist-value 64
              hll-sparse-max-bytes 3000
              stream-node-max-bytes 4096
              stream-node-max-entries 100
              
              # Active Rehashing
              activerehashing yes
              
              # Client Output Buffer Limits
              client-output-buffer-limit normal 0 0 0
              client-output-buffer-limit replica 256mb 64mb 60
              client-output-buffer-limit pubsub 32mb 8mb 60
              
              # Frequency
              hz 10
              
              # AOF Rewrite
              aof-rewrite-incremental-fsync yes
              
              # RDB
              rdb-save-incremental-fsync yes
          notify: restart redis
          
        - name: Create Redis directories
          file:
            path: "{{ item }}"
            state: directory
            owner: redis
            group: redis
            mode: '0750'
          loop:
            - "{{ redis_dir }}"
            - "{{ redis_log_dir }}"
            - /var/run/redis
            
        - name: Configure Redis systemd service
          copy:
            dest: /etc/systemd/system/redis.service
            content: |
              [Unit]
              Description=Redis In-Memory Data Store
              After=network.target
              
              [Service]
              Type=notify
              ExecStart=/usr/bin/redis-server /etc/redis/redis.conf
              ExecStop=/usr/bin/redis-cli shutdown
              TimeoutStopSec=0
              Restart=on-failure
              User=redis
              Group=redis
              RuntimeDirectory=redis
              RuntimeDirectoryMode=0755
              
              # Security
              NoNewPrivileges=true
              PrivateTmp=true
              ProtectSystem=strict
              ProtectHome=true
              ReadWritePaths={{ redis_dir }} {{ redis_log_dir }}
              
              # Tuning
              LimitNOFILE=65535
              
              [Install]
              WantedBy=multi-user.target
          notify: reload systemd

    # ========================================
    # REDIS SECURITY
    # ========================================
    - name: Secure Redis Installation
      tags: [security]
      block:
        - name: Ensure Redis binds only to localhost
          lineinfile:
            path: /etc/redis/redis.conf
            regexp: '^bind'
            line: 'bind 127.0.0.1 ::1'
          notify: restart redis

    # ========================================
    # REDIS OPTIMIZATION
    # ========================================
    - name: Optimize Redis Performance
      tags: [optimize]
      block:
        - name: Configure kernel parameters for Redis
          sysctl:
            name: "{{ item.key }}"
            value: "{{ item.value }}"
            state: present
            reload: yes
          loop:
            - { key: "vm.overcommit_memory", value: "1" }
            - { key: "net.core.somaxconn", value: "65535" }
            - { key: "net.ipv4.tcp_max_syn_backlog", value: "65535" }
            
        - name: Disable Transparent Huge Pages
          shell: |
            echo never > /sys/kernel/mm/transparent_hugepage/enabled
            echo never > /sys/kernel/mm/transparent_hugepage/defrag
          
        - name: Make THP settings persistent
          copy:
            dest: /etc/rc.local
            content: |
              #!/bin/bash
              echo never > /sys/kernel/mm/transparent_hugepage/enabled
              echo never > /sys/kernel/mm/transparent_hugepage/defrag
              exit 0
            mode: '0755'

    # ========================================
    # START REDIS
    # ========================================
    - name: Start and Enable Redis
      tags: [start]
      systemd:
        name: redis
        state: started
        enabled: yes
        daemon_reload: yes
        
    - name: Verify Redis is running
      command: redis-cli ping
      register: redis_ping
      changed_when: false
      failed_when: redis_ping.stdout != "PONG"
      
    - name: Show Redis info
      shell: |
        redis-cli -a "{{ redis_password }}" INFO server | grep -E "redis_version|tcp_port|config_file"
      register: redis_info
      changed_when: false
      
    - name: Display Redis status
      debug:
        msg:
          - "Redis installation complete!"
          - "Status: {{ redis_ping.stdout }}"
          - "{{ redis_info.stdout_lines }}"
          - "Redis password configured from vault"

  handlers:
    - name: restart redis
      systemd:
        name: redis
        state: restarted
        
    - name: reload systemd
      systemd:
        daemon_reload: yes