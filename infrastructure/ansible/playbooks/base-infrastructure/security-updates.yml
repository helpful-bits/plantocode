---
# Security Updates Playbook
# This is imported by site.yml with the security-updates tag

- name: Apply Security Updates
  hosts: all
  become: yes
  tags: [security-updates]
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
    
    - name: Upgrade all packages (security updates)
      apt:
        upgrade: safe
        autoremove: yes
        autoclean: yes
      register: apt_upgrade
      environment:
        DEBIAN_FRONTEND: noninteractive
    
    - name: Show packages that were upgraded
      debug:
        msg: "{{ apt_upgrade.stdout_lines }}"
      when: apt_upgrade.changed
    
    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required
    
    - name: Notify if reboot needed
      debug:
        msg: 
          - "WARNING: Server requires a reboot for kernel updates!"
          - "Run: ansible -i inventory/hosts.yml hetzner -m reboot --become"
      when: reboot_required.stat.exists
    
    - name: Clean package cache
      apt:
        autoclean: yes
        autoremove: yes
    
    - name: Update fail2ban if it was upgraded
      systemd:
        name: fail2ban
        state: restarted
      when: "'fail2ban' in (apt_upgrade.stdout | default(''))"
    
    - name: Verify all security services are running
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - ufw
        - fail2ban
        - unattended-upgrades
        - postgresql@17-main
      failed_when: false
      register: service_status
    
    - name: Report service status
      debug:
        msg: "{{ item.item }}: {{ item.status.ActiveState | default('not installed') }}"
      loop: "{{ service_status.results }}"